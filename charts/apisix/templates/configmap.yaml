#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "apisix.fullname" . }}
  namespace: {{ .Release.Namespace }}
data:
  config.yaml: |-
    #
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
    
    # Pingora framework configuration
    pingora:
      version: {{ .Values.pingora.version }}
      threads: {{ .Values.pingora.threads }}
      pid_file: {{ .Values.pingora.pidFile | quote }}
      upgrade_sock: {{ .Values.pingora.upgradeSock | quote }}
      {{- if .Values.pingora.user }}
      user: {{ .Values.pingora.user | quote }}
      {{- end }}
      {{- if .Values.pingora.group }}
      group: {{ .Values.pingora.group | quote }}
      {{- end }}

    # Pingsix gateway configuration
    pingsix:
      # Listeners configuration
      listeners:
      {{- range $idx, $listener := .Values.pingsix.listeners }}
        - address: {{ $listener.address | quote }}
          {{- if $listener.tls }}
          tls:
            {{- if $listener.tls.secretName }}
            {{- /* Use certificate from Kubernetes Secret */ -}}
            cert_path: {{ printf "/etc/pingsix/tls/listener-%d/%s" $idx ($listener.tls.certFilename | default "tls.crt") | quote }}
            key_path: {{ printf "/etc/pingsix/tls/listener-%d/%s" $idx ($listener.tls.keyFilename | default "tls.key") | quote }}
            {{- else }}
            {{- /* Use direct file paths */ -}}
            cert_path: {{ $listener.tls.certPath | quote }}
            key_path: {{ $listener.tls.keyPath | quote }}
            {{- end }}
          {{- end }}
          {{- if $listener.offerH2 }}
          offer_h2: {{ $listener.offerH2 }}
          {{- end }}
          {{- if $listener.offerH2c }}
          offer_h2c: {{ $listener.offerH2c }}
          {{- end }}
      {{- end }}

      {{- /* Determine etcd configuration based on priority */ -}}
      {{- $etcdEnabled := false -}}
      {{- $etcdHost := list -}}
      {{- $etcdPrefix := .Values.etcd.prefix | default "/apisix" -}}
      {{- $etcdTimeout := .Values.etcd.timeout | default 30 -}}
      
      {{- /* Priority 1: Ingress controller etcd service */ -}}
      {{- if (index .Values "ingress-controller" "enabled") -}}
        {{- $etcdEnabled = true -}}
        {{- $ingressEtcdPort := index .Values "ingress-controller" "etcd" "port" | default "12379" -}}
        {{- $ingressControllerName := printf "%s-ingress-controller" .Release.Name -}}
        {{- $etcdHost = list (printf "http://%s:%s" $ingressControllerName $ingressEtcdPort) -}}
        {{- $etcdPrefix = index .Values "ingress-controller" "etcd" "prefix" | default "/apisix" -}}
      {{- /* Priority 2: Built-in etcd */ -}}
      {{- else if .Values.etcd.enabled -}}
        {{- $etcdEnabled = true -}}
        {{- $etcdScheme := include "apisix.etcd.auth.scheme" . -}}
        {{- if .Values.etcd.fullnameOverride -}}
          {{- $etcdHost = list (printf "%s://%s:%d" $etcdScheme .Values.etcd.fullnameOverride (.Values.etcd.service.port | int)) -}}
        {{- else -}}
          {{- $etcdHost = list (printf "%s://%s-etcd.%s.svc.cluster.local:%d" $etcdScheme .Release.Name .Release.Namespace (.Values.etcd.service.port | int)) -}}
        {{- end -}}
      {{- /* Priority 3: External etcd */ -}}
      {{- else if .Values.externalEtcd.host -}}
        {{- $etcdEnabled = true -}}
        {{- $etcdHost = .Values.externalEtcd.host -}}
      {{- end -}}

      {{- /* Configure etcd or static resources */ -}}
      {{- if $etcdEnabled }}
      # Etcd configuration for dynamic resource management
      etcd:
        host:
        {{- range $etcdHost }}
          - {{ . | quote }}
        {{- end }}
        prefix: {{ $etcdPrefix | quote }}
        timeout: {{ $etcdTimeout }}
        {{- if and .Values.etcd.enabled .Values.etcd.auth.rbac.create .Values.etcd.auth.rbac.rootPassword }}
        user: "root"
        password: {{ .Values.etcd.auth.rbac.rootPassword | quote }}
        {{- else if and (not .Values.etcd.enabled) .Values.externalEtcd.user .Values.externalEtcd.password }}
        user: {{ .Values.externalEtcd.user | quote }}
        password: {{ .Values.externalEtcd.password | quote }}
        {{- end }}
      {{- end }}

      {{- /* Admin API configuration */ -}}
      {{- if .Values.pingsix.admin.enabled }}
      # Admin API configuration
      admin:
        address: {{ .Values.pingsix.admin.address | quote }}
        api_key: {{ .Values.pingsix.admin.apiKey | quote }}
      {{- end }}

      {{- /* Status endpoint configuration */ -}}
      {{- if .Values.pingsix.status.enabled }}
      # Status/health check endpoint
      status:
        address: {{ .Values.pingsix.status.address | quote }}
      {{- end }}

      {{- /* Prometheus metrics configuration */ -}}
      {{- if .Values.pingsix.prometheus.enabled }}
      # Prometheus metrics endpoint
      prometheus:
        address: {{ .Values.pingsix.prometheus.address | quote }}
      {{- end }}

      {{- /* Sentry configuration */ -}}
      {{- if and .Values.pingsix.sentry.enabled .Values.pingsix.sentry.dsn }}
      # Sentry error tracking
      sentry:
        dsn: {{ .Values.pingsix.sentry.dsn | quote }}
      {{- end }}

      {{- /* Custom log file configuration */ -}}
      {{- if and .Values.pingsix.log.enabled .Values.pingsix.log.path }}
      # Custom log file
      log:
        path: {{ .Values.pingsix.log.path | quote }}
      {{- end }}

    {{- /* Static resources configuration (only when etcd is not enabled) */ -}}
    {{- if not $etcdEnabled }}
    # Static routes configuration
    {{- if .Values.routes }}
    routes:
      {{- toYaml .Values.routes | nindent 6 }}
    {{- else }}
    routes: []
    {{- end }}

    # Static upstreams configuration
    {{- if .Values.upstreams }}
    upstreams:
      {{- toYaml .Values.upstreams | nindent 6 }}
    {{- else }}
    upstreams: []
    {{- end }}

    # Static services configuration
    {{- if .Values.services }}
    services:
      {{- toYaml .Values.services | nindent 6 }}
    {{- else }}
    services: []
    {{- end }}

    # Static global rules configuration
    {{- if .Values.globalRules }}
    global_rules:
      {{- toYaml .Values.globalRules | nindent 6 }}
    {{- else }}
    global_rules: []
    {{- end }}

    # Static SSL certificates configuration
    {{- if .Values.ssls }}
    ssls:
      {{- toYaml .Values.ssls | nindent 6 }}
    {{- else }}
    ssls: []
    {{- end }}
    {{- end }}
