#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

global:
  # e.g.
  # imagePullSecrets:
  #   - my-registry-secrets
  #   - other-registry-secrets
  # -- Global Docker registry secret names as an array
  imagePullSecrets: []

image:
  # -- Pingsix image repository
  repository: zhu327/pingsix
  # -- Pingsix image pull policy
  pullPolicy: IfNotPresent
  # -- Pingsix image tag
  # Overrides the image tag whose default is the chart appVersion.
  tag: latest

# -- set false to use `Deployment`, set true to use `DaemonSet`
useDaemonSet: false
# -- if useDaemonSet is true or autoscaling.enabled is true, replicaCount not become effective
replicaCount: 1

# -- Set [priorityClassName](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/#pod-priority) for Pingsix pods
priorityClassName: ""
# -- Annotations to add to each pod
podAnnotations: {}
# -- Set the securityContext for Pingsix pods
podSecurityContext: {}
  # fsGroup: 2000
# -- Set the securityContext for Pingsix container
securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

# -- See https://kubernetes.io/docs/tasks/run-application/configure-pdb/ for more details
podDisruptionBudget:
  # -- Enable or disable podDisruptionBudget
  enabled: false
  # -- Set the `minAvailable` of podDisruptionBudget. You can specify only one of `maxUnavailable` and `minAvailable` in a single PodDisruptionBudget.
  # See [Specifying a Disruption Budget for your Application](https://kubernetes.io/docs/tasks/run-application/configure-pdb/#specifying-a-poddisruptionbudget)
  # for more details
  minAvailable: 90%
  # -- Set the maxUnavailable of podDisruptionBudget
  maxUnavailable: 1

# -- Set pod resource requests & limits
resources: {}
  # -- Use the host's network namespace

  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi
hostNetwork: false

# -- Node labels for Pingsix pod assignment
nodeSelector: {}
# -- List of node taints to tolerate
tolerations: []
# -- Set affinity for Pingsix deploy
affinity: {}
# -- Topology Spread Constraints for pod assignment spread across your cluster among failure-domains
# ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#spread-constraints-for-pods
topologySpreadConstraints: []

# -- timezone is the timezone where pingsix uses.
# For example: "UTC" or "Asia/Shanghai"
# This value will be set on pingsix container's environment variable TZ.
# You may need to set the timezone to be consistent with your local time zone,
# otherwise the pingsix's logs may used to retrieve event maybe in wrong timezone.
timezone: ""

# -- extraEnvVars An array to add extra env vars
# e.g:
# extraEnvVars:
#   - name: FOO
#     value: "bar"
#   - name: FOO2
#     valueFrom:
#       secretKeyRef:
#         name: SECRET_NAME
#         key: KEY
extraEnvVars: []

updateStrategy: {}
  # type: RollingUpdate

# -- Additional Kubernetes resources to deploy with the release.
extraDeploy: []

# -- Additional `volume`, See [Kubernetes Volumes](https://kubernetes.io/docs/concepts/storage/volumes/) for the detail.
extraVolumes: []
# - name: extras
#   emptyDir: {}

# -- Additional `volume`, See [Kubernetes Volumes](https://kubernetes.io/docs/concepts/storage/volumes/) for the detail.
extraVolumeMounts: []
# - name: extras
#   mountPath: /usr/share/extras
#   readOnly: true

# -- Additional `initContainers`, See [Kubernetes initContainers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) for the detail.
extraInitContainers: []
# - name: init-myservice
#   image: busybox:1.28
#   command: ['sh', '-c', "until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done"]

# -- Additional `containers`, See [Kubernetes containers](https://kubernetes.io/docs/concepts/containers/) for the detail.
extraContainers: []

initContainer:
  # -- Init container image
  image: busybox
  # -- Init container tag
  tag: 1.28

autoscaling:
  enabled: false
  # -- HPA version, the value is "v2" or "v2beta1", default "v2"
  version: v2
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: false
  annotations: {}
  name: ""

rbac:
  create: false

service:
  # -- Pingsix service type for user access itself
  type: NodePort
  # -- Setting how the Service route external traffic
  # If you want to keep the client source IP, you can set this to Local.

  # ref: https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip
  externalTrafficPolicy: Cluster
  # type: LoadBalancer
  # annotations:
  #   service.beta.kubernetes.io/aws-load-balancer-type: nlb
  annotations: {}
  externalIPs: []
  # -- Override default labels assigned to Pingsix gateway resources
  labelsOverride: {}
  # labelsOverride:
  #   app.kubernetes.io/name: "{{ .Release.Name }}"
  #   app.kubernetes.io/instance: '{{ include "pingsix.name" . }}'

# -- Using ingress access Pingsix service
ingress:
  enabled: false
  # -- (number) Service port to send traffic. Defaults to the first listener port.
  servicePort:
  # -- Ingress annotations
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: pingsix.local
      paths: []
  tls: []

# -- Observability configuration.
metrics:
  serviceMonitor:
    # -- Enable or disable Pingsix serviceMonitor
    enabled: false
    # -- namespace where the serviceMonitor is deployed, by default, it is the same as the namespace of the pingsix
    namespace: ""
    # -- name of the serviceMonitor, by default, it is the same as the pingsix fullname
    name: ""
    # -- interval at which metrics should be scraped
    interval: 15s
    # -- @param serviceMonitor.labels ServiceMonitor extra labels
    labels: {}
    # -- @param serviceMonitor.annotations ServiceMonitor annotations
    annotations: {}

# -- Pingora framework configuration
# ref: https://github.com/cloudflare/pingora/blob/main/docs/user_guide/conf.md
pingora:
  # -- Pingora config version
  version: 1
  # -- Number of worker threads
  threads: 2
  # -- PID file path
  pidFile: /run/pingora.pid
  # -- Upgrade socket path for graceful upgrades
  upgradeSock: /tmp/pingora_upgrade.sock
  # -- User to run as (if started as root)
  user: nobody
  # -- Group to run as
  group: webusers

# -- Pingsix gateway configuration
pingsix:
  # -- Log level for Pingsix (RUST_LOG environment variable)
  # Valid values: error, warn, info, debug, trace
  logLevel: "info"
  
  # -- HTTP/HTTPS listeners configuration
  # Each listener binds to an address and can optionally enable TLS and HTTP/2
  listeners:
    - address: "0.0.0.0:8080"
      offerH2c: false
    # Example HTTPS listener with HTTP/2 using TLS certificates from Secret
    # First create a secret: kubectl create secret tls pingsix-tls --cert=server.crt --key=server.key
    # - address: "0.0.0.0:8443"
    #   tls:
    #     # Option 1: Use certificates from Kubernetes Secret (recommended)
    #     secretName: pingsix-tls
    #     # Optional: Specify custom key names in the secret (defaults: tls.crt, tls.key)
    #     # certFilename: tls.crt
    #     # keyFilename: tls.key
    #     # Option 2: Use direct file paths (not recommended for production)
    #     # certPath: /etc/ssl/server.crt
    #     # keyPath: /etc/ssl/server.key
    #   offerH2: true

  # -- Admin API configuration
  # The admin API allows managing routes, upstreams, etc. dynamically when etcd is configured
  admin:
    enabled: true
    address: "0.0.0.0:9181"
    # -- API key for admin authentication (can be overridden via secret)
    apiKey: "edd1c9f034335f136f87ad84b625c8f1"
    # -- Using ingress access Pingsix admin service
    ingress:
      enabled: false
      # -- Ingress annotations
      annotations: {}
      hosts:
        - host: apisix-admin.local
          paths:
            - "/*"
      tls: []

  # -- Status/health check endpoint configuration
  # Independent of admin API, useful for Kubernetes readiness probes and load balancer health checks
  status:
    enabled: true
    address: "0.0.0.0:7085"

  # -- Prometheus metrics configuration
  prometheus:
    enabled: false
    address: "0.0.0.0:9091"

  # -- Sentry integration for error tracking
  sentry:
    enabled: false
    dsn: ""

  # -- Custom log file configuration
  # By default, logs go to stdout/stderr
  log:
    enabled: false
    path: ""

# -- Static routes configuration (used when etcd is not configured)
# Routes define how incoming requests are matched and forwarded to upstreams
# ref: https://apisix.apache.org/docs/apisix/admin-api/#route
routes: []
  # Example route configuration:
  # - id: "1"
  #   uri: /
  #   host: www.example.com
  #   methods: ["GET", "POST"]
  #   priority: 10
  #   timeout:
  #     connect: 2
  #     send: 3
  #     read: 5
  #   upstream:
  #     nodes:
  #       "backend.svc.cluster.local:8080": 1
  #     type: roundrobin
  #     scheme: http
  #   plugins:
  #     echo:
  #       body: "Hello world!"

# -- Static upstreams configuration (used when etcd is not configured)
# Upstreams define backend server groups with load balancing and health check configurations
# ref: https://apisix.apache.org/docs/apisix/admin-api/#upstream
upstreams: []
  # Example upstream configuration:
  # - id: "1"
  #   nodes:
  #     "backend1.example.com:8080": 1
  #     "backend2.example.com:8080": 1
  #   type: roundrobin
  #   retries: 2
  #   retry_timeout: 10
  #   timeout:
  #     connect: 2
  #     send: 3
  #     read: 5
  #   checks:
  #     active:
  #       type: https
  #       timeout: 1
  #       host: backend.example.com
  #       http_path: /health
  #       https_verify_certificate: true
  #       healthy:
  #         interval: 5
  #         http_statuses: [200, 201]
  #         successes: 2
  #       unhealthy:
  #         http_failures: 5
  #         tcp_failures: 2
  #   hash_on: vars
  #   key: uri
  #   pass_host: rewrite
  #   upstream_host: backend.example.com
  #   scheme: https

# -- Static services configuration (used when etcd is not configured)
# Services group routes with common upstream and plugin configurations
# ref: https://apisix.apache.org/docs/apisix/admin-api/#service
services: []
  # Example service configuration:
  # - id: "1"
  #   hosts: ["api.example.com"]
  #   upstream_id: "1"
  #   plugins:
  #     limit-count:
  #       key_type: head
  #       key: Host
  #       time_window: 1
  #       count: 100
  #       rejected_code: 429

# -- Static global rules configuration (used when etcd is not configured)
# Global rules apply to all requests before route matching
globalRules: []
  # Example global rule configuration:
  # - id: "1"
  #   plugins:
  #     prometheus: {}

# -- Static SSL certificates configuration (used when etcd is not configured)
# SSL certificates for TLS termination
ssls: []
  # Example SSL configuration:
  # - id: "1"
  #   cert: |
  #     -----BEGIN CERTIFICATE-----
  #     ...
  #     -----END CERTIFICATE-----
  #   key: |
  #     -----BEGIN PRIVATE KEY-----
  #     ...
  #     -----END PRIVATE KEY-----
  #   snis:
  #     - "*.example.com"
  #     - "example.com"

# -- external etcd configuration. If etcd.enabled is false, these configuration will be used.
externalEtcd:
  # -- if etcd.enabled is false, use external etcd, support multiple address, if your etcd cluster enables TLS, please use https scheme, e.g. https://127.0.0.1:2379.
  host:
    # host or ip e.g. http://172.20.128.89:2379
    # - http://etcd.host:2379
  # -- if etcd.enabled is false, user for external etcd. Set empty to disable authentication
  user: root
  # -- if etcd.enabled is true, use etcd.auth.rbac.rootPassword instead.
  # -- if etcd.enabled is false, password for external etcd. WARNING: This will be stored in plain text in the ConfigMap.
  password: ""

# -- etcd configuration
# use the FQDN address or the IP of the etcd
etcd:
  # -- install built-in etcd by default, set false if do not want to install built-in etcd together,
  # this etcd is based on bitnamilegacy/etcd helm chart and latest bitnami docker image, only for development and testing purposes,
  # if you want to use etcd in production, we recommend you to install etcd by yourself and use `externalEtcd` to connect it.
  enabled: true
  # -- docker image for built-in etcd
  image:
    registry: docker.io
    repository: bitnamilegacy/etcd
    # -- `bitnamilegacy/etcd` only provide `latest` tag now, ref: https://github.com/bitnami/containers/issues/83267,
    # you can switch `etcd.image.repository` to `bitnamilegacy/etcd` to use old versioned tags.
    tag: latest

  # -- pingsix configurations prefix
  prefix: "/apisix"
  # -- Set the timeout value in seconds for subsequent socket operations from pingsix to etcd cluster
  timeout: 30

  # -- if etcd.enabled is true, set more values of bitnamilegacy/etcd helm chart
  auth:
    rbac:
      # -- No authentication by default. Switch to enable RBAC authentication
      create: false
      # -- root password for etcd. Requires etcd.auth.rbac.create to be true.
      rootPassword: ""
    tls:
      # -- enable etcd client certificate
      enabled: false

  # -- ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container
  # -- added for backward compatibility with old kubernetes versions, as seccompProfile is not supported in kubernetes < 1.19
  containerSecurityContext:
    enabled: false

  service:
    port: 2379

  replicaCount: 3
  autoCompactionRetention: "1h"
  autoCompactionMode: "periodic"

# -- Ingress controller configuration
ingress-controller:
  enabled: false

  # Etcd Adapter configuration
  etcd:
    port: "12379"
    prefix: "/apisix"
